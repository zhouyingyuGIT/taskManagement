<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ page language="java" import="com.lattice.entity.*"%>
<%@ page language="java" import="com.lattice.dao.*,java.util.*"%>
<%@page import="javax.servlet.jsp.jstl.fmt.LocaleSupport"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>


<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta http-equiv="pragma" content="no-cache">
<meta http-equiv="cache-control" content="no-cache">
<meta http-equiv="expires" content="0">
<script type="text/javascript" src="/lattice/OPES2/js/jquery/jquery-1.8.0.min.js"></script>

<script type='text/javascript'
	src='/lattice/OPES2/js/jqueryui/jquery-ui-1.10.4.custom.min.js'></script>
<script type='text/javascript'
	src='/lattice/OPES2/js/mousetrap/mousetrap-1.4.6.min.js'></script>
<script type='text/javascript' src='/lattice/OPES2/js/json2/json2.js'></script>
<script type='text/javascript'
	src='/lattice/OPES2/opes-template/util.js'></script>

<SCRIPT src="/lattice/js/Statistics/Statistics.js" type=text/javascript></SCRIPT>

<title>记忆矩阵（Memory Matrix）</title>
<script type="text/javascript">
			
		var userDefinedKeys=['p'];
		var userTypedKeyList=[];
		var mts=[];
		var current_index=0;
		var start_time=getTimestamp();
		var eachSimulateStartTS=getTimestamp();
		
		jQuery(document).ready(function () 
		{
			placeTableToCenter();
			Mousetrap.bind(userDefinedKeys, function(e) {process_user_response_single_key(String.fromCharCode(e.keyCode||e.which));});
			generateAllData();
			show_next_simulate();
		});
		function placeTableToCenter()
		{
			$('#tb_div').css({'position':'absolute','width':'300px','height':'300px'});
			$('#tb_div').position({
				my: 'center center',
				at: 'center center',
				collision: "none",
				of: $(document)
			});
		}
		function generateAllData()
		{
			var blocks=10;
			for(var i=0;i<blocks;i++)
			{
				generateFix(3000);
				generateOneBlockData();
				generateFix(3000);
				if(i!=(blocks-1))
				{
					//去掉中间休息时间
					//generateBlank(5000);
				}
			}
			//debugGeneratedData();
		}
		function generateFix(duration)
		{
			var fix={};
			fix.type='fix';
			fix.duration=duration;
			
			mts.push(fix);
		}
		function generateBlank(duration)
		{
			var blank={};
			blank.type='blank';
			blank.duration=duration;
			
			mts.push(blank);
		}
		
		function generateOneBlockData()
		{
			var tempGlobalMts=[];
			//1. gen 11-3=8 trial 
			var totalArray=[1,2,3,4,5,6,7,8,0,1];
			totalArray=shuffle_all_items(totalArray);
			for(var i=0;i<totalArray.length;i++)
			{
				var positionNeedToBe1=totalArray[i];
				var temprow=parseInt(positionNeedToBe1/3);//8/3=2, so it is the second row
				var tempcol=parseInt(positionNeedToBe1%3);//8%3=2, so it is the seocnd col
				
				var trial={};
				trial.type='data';
				trial.data=[];
				for(var row=0;row<3;row++)
				{
					var rowdata=[];
					for(var col=0;col<3;col++)
					{
						if(temprow==row&&tempcol==col)
						{
							rowdata.push(1);
						}else
						{
							rowdata.push(0);
						}
					}
					trial.data.push(rowdata);
				}
				trial.correctAnswer=false;
				tempGlobalMts.push(trial);
			}
			
			//2. gen 3 same trial
			//0 1 2 3 (0) 4 5 (3) 6 7 (5) 8 9
			//alert(Math.floor(Math.random()*(4-3+1)+3));
			var firstSameSimulatePosition=4;//start from 0, same as 0
			var secondSameSimulatePosition=6;// same as 3
			var thirdSameSimulatePosition=8;//same as 5
			
			
			//3. insert the 3 trial to 8
			var randomInterval2orInterval3=Math.floor(Math.random()*(2-1+1)+1);
			if(randomInterval2orInterval3==1)
			{
				var tempFir=jQuery.extend(true, {}, tempGlobalMts[0]);
				var tempSec=jQuery.extend(true, {}, tempGlobalMts[3]);
				var tempThir=jQuery.extend(true, {}, tempGlobalMts[5]);
				tempFir.correctAnswer=true;
				tempSec.correctAnswer=true;
				tempThir.correctAnswer=true;
				
				var randomPosition=Math.floor(Math.random()*(2-1+1)+1);
				if(randomPosition==1)
				{
					mts.push(tempGlobalMts[0]);
					mts.push(tempGlobalMts[1]);
					mts.push(tempGlobalMts[2]);
					mts.push(tempGlobalMts[3]);
					mts.push(tempFir);
					mts.push(tempGlobalMts[4]);
					mts.push(tempGlobalMts[5]);
					mts.push(tempSec);
					mts.push(tempGlobalMts[6]);
					mts.push(tempGlobalMts[7]);
					mts.push(tempThir);
					mts.push(tempGlobalMts[8]);
					mts.push(tempGlobalMts[9]);
				}else if(randomPosition==2)
				{
					mts.push(tempGlobalMts[9]);
					mts.push(tempGlobalMts[0]);
					mts.push(tempGlobalMts[1]);
					mts.push(tempGlobalMts[2]);
					mts.push(tempGlobalMts[3]);
					mts.push(tempFir);
					mts.push(tempGlobalMts[4]);
					mts.push(tempGlobalMts[5]);
					mts.push(tempSec);
					mts.push(tempGlobalMts[6]);
					mts.push(tempGlobalMts[7]);
					mts.push(tempThir);
					mts.push(tempGlobalMts[8]);
					
				}else
				{
					alert('wrong index');
				}
			}else
			{
				var tempFir=jQuery.extend(true, {}, tempGlobalMts[0]);
				var tempSec=jQuery.extend(true, {}, tempGlobalMts[0]);
				var tempThir=jQuery.extend(true, {}, tempGlobalMts[6]);
				tempFir.correctAnswer=true;
				tempSec.correctAnswer=true;
				tempThir.correctAnswer=true;
				
				var randomPosition=Math.floor(Math.random()*(2-1+1)+1);
				if(randomPosition==1)
				{
					mts.push(tempGlobalMts[0]);
					mts.push(tempGlobalMts[1]);
					mts.push(tempGlobalMts[2]);
					mts.push(tempGlobalMts[3]);
					mts.push(tempFir);
					mts.push(tempGlobalMts[4]);
					mts.push(tempGlobalMts[5]);
					mts.push(tempGlobalMts[6]);
					mts.push(tempSec);
					mts.push(tempGlobalMts[7]);
					mts.push(tempGlobalMts[8]);
					mts.push(tempThir);
					mts.push(tempGlobalMts[9]);
				}else if(randomPosition==2)
				{
					mts.push(tempGlobalMts[9]);
					mts.push(tempGlobalMts[0]);
					mts.push(tempGlobalMts[1]);
					mts.push(tempGlobalMts[2]);
					mts.push(tempGlobalMts[3]);
					mts.push(tempFir);
					mts.push(tempGlobalMts[4]);
					mts.push(tempGlobalMts[5]);
					mts.push(tempGlobalMts[6]);
					mts.push(tempSec);
					mts.push(tempGlobalMts[7]);
					mts.push(tempGlobalMts[8]);
					mts.push(tempThir);
					
				}else
				{
					alert('wrong index');
				}
			}
			
			
		}
		
		function debugGeneratedData()
		{
			for(var k=0;k<mts.length;k++)
			{
				$('body').append(JSON.stringify({mtsArray:mts[k]}));
				$('body').append('<br/>');
			}
		}
		function process_user_response_single_key(userTypedKey)
		{
			var duration=getTimestamp()-eachSimulateStartTS;
			eachSimulateStartTS=getTimestamp();
			var userResultObj={};
			userResultObj.userTypedKey=userTypedKey;
			userResultObj.current_index=current_index-1;
			userResultObj.isCorrect=mts[current_index-1].correctAnswer;
			userResultObj.correctAnswer=mts[current_index-1].correctAnswer;
			userResultObj.duration=duration;
			userTypedKeyList.push(userResultObj);
			$('#tips').html('√');
			$('#tips').fadeIn(0);
			$('#tips').fadeOut(2000);
		}
		
		function show_next_simulate()
		{
			if(current_index<mts.length)
			{
				var trial=mts[current_index];
				if(trial.type=='fix')
				{
					$('#tb').hide();
					$('#fix_id').remove();
					$('body').append('<span style="display:block;font-size:90px;color:#000;" id="fix_id">+</span>');
					$('#fix_id').css({'position':'absolute'});
					$('#fix_id').show();
					$('#fix_id').position({
						my: 'center center',
						at: 'center center',
						collision: "none",
						of: $(document)
					});
					setTimeout(show_next_simulate, trial.duration);
				}else if(trial.type=='blank')
				{
					$('#tb').hide();
					$('#fix_id').remove();
					$('body').append('<span style="display:block;font-size:90px;color:#000;" id="fix_id">+</span>');
					$('#fix_id').html('休息一下，马上开始新一轮');
					$('#fix_id').css({'position':'absolute'});
					$('#fix_id').show();
					$('#fix_id').position({
						my: 'center center',
						at: 'center center',
						collision: "none",
						of: $(document)
					});
					setTimeout(show_next_simulate, trial.duration);
				}else if(trial.type=='data')
				{
					eachSimulateStartTS=getTimestamp();
					$('#tb').show();
					$('#fix_id').hide();
					//alert(current_index+'============='+JSON.stringify(trial));
					show_simulate(trial);
					setTimeout(show_next_simulate, 3000);
				}
				
				current_index++;
			}else
			{
				postResults();
			}
		}
		function show_fix___________________________(callback)
		{
			
			$('#tb').hide();
			$('#fix_id').remove();
			$('body').append('<span style="display:block;font-size:90px;color:blue;" id="fix_id">+</span>');
			$('#fix_id').css({'position':'absolute'});
			$('#fix_id').show();
			$('#fix_id').position({
				my: 'center center',
				at: 'center center',
				collision: "none",
				of: $(document)
			});
			
			//setTimeout($('#fix_id').hide(), 30000);
			setTimeout(callback, 3000);
		}
		
			function change_view___________________________()
			{
				eachSimulateStartTS=getTimestamp();
				$('#tb').show();
				$('#fix_id').hide();
				//alert(mts.length)
				if(current_index<mts.length)
				{
					var trial=mts[current_index];
					//alert(current_index+''+JSON.stringify(trial));
					show_simulate(trial);
					
					current_index++;
					setTimeout(change_view, 3000);
				}else
				{
					show_fix(postResults);
				}
			}
			function postResults()
			{
				userTypedKeyList=removeDuplicateTypedKey();
				userTypedKeyList=reOrderUserTypedKey();
				//alert(JSON.stringify(userTypedKeyList));
				post_result(userTypedKeyList);
			}
			function reOrderUserTypedKey()
			{
				var newUserTypedKeyList=[];
				for(var n=0;n<=mts.length;n++)
				{
					for(var i=0;i<userTypedKeyList.length;i++)
					{
						var tempk=userTypedKeyList[i];
						if(n==tempk.current_index)
						{
							newUserTypedKeyList.push(tempk);
							if(tempk.userTypedKey==0)
							{
								tempk.duration=0;
							}
							break;
						}
					}
				}
				
				return newUserTypedKeyList;
			}
			function removeDuplicateTypedKey()
			{
				//below is to remove duplicate typed keys results
				var newUserTypedKeyList=[];
				for(var i=0;i<userTypedKeyList.length;i++)
				{
					var tempk=userTypedKeyList[i];
					
					var contains=false;
					for(var k=0;k<newUserTypedKeyList.length;k++)
					{
						var newtempk=newUserTypedKeyList[k];
						if(tempk.current_index==newtempk.current_index)
						{
							contains=true;
							break;
						}
					}
					if(!contains)
					{
						newUserTypedKeyList.push(tempk);
					}
				}
				
				//add all the rest results, which user did not type key
				for(var i=0;i<mts.length;i++)
				{
					var tempk=mts[i];
					if(tempk.type=='data')
					{
						var contains=false;
						for(var k=0;k<newUserTypedKeyList.length;k++)
						{
							if(i==newUserTypedKeyList[k].current_index)
							{
								contains=true;
								break;
							}
						}
						if(!contains)
						{
							var notTyped={};
							notTyped.userTypedKey='0';
							notTyped.current_index=i;
							notTyped.isCorrect=tempk.correctAnswer?false:true;
							notTyped.correctAnswer=tempk.correctAnswer;
							notTyped.duration=3000;
							newUserTypedKeyList.push(notTyped);
						}
					}
				}
				
				
				return newUserTypedKeyList;
			}
			function show_simulate(trial)
			{
				//alert(current_index+''+JSON.stringify(trial));
				var content="";
				for(var i=0;i<trial.data.length;i++)
				{
					var trow=trial.data[i];
					
					var tr="<tr style='width:100px;height:100px;'>";
					for(var d=0;d<trow.length;d++)
					{
						if(trow[d]==1)
						{
							tr+="<td style='width:100px;height:100px;border:1px solid;background-color:#000;'></td>";
						}else
						{
							tr+="<td style='width:100px;height:100px;border:1px solid;'></td>";
						}
					}
					tr+="</tr>";
					content+=tr;
				}
				//alert(content);
				$('#tb').html(content);
				setTimeout(show_blank, 500,trial);
			}
			function show_blank(trial)
			{
				var content="";
				for(var i=0;i<trial.data.length;i++)
				{
					var trow=trial.data[i];
					
					var tr="<tr style='width:100px;height:100px;'>";
					for(var d=0;d<trow.length;d++)
					{
						tr+="<td style='width:100px;height:100px;border:1px solid;'></td>";
					}
					tr+="</tr>";
					
					content+=tr;
				}
				$('#tb').html(content);
			}
			
			
			//see this method 3DF.jsp
			function post_result(newUserTypedKeyList)
			{
				var corrects=new Array();
				var users=new Array();
				var rc_time=new Array();
				var stimidAll=new Array();
				var type4All=new Array();
				
				for(var k=0;k<newUserTypedKeyList.length;k++)
				{
					var newtempk=newUserTypedKeyList[k];
					corrects.push(newtempk.correctAnswer?'p':0);
					users.push(newtempk.userTypedKey);
					rc_time.push(newtempk.duration);
					//stimidAll.push(newtempk.current_index);
					stimidAll.push(k+1);
					type4All.push(newtempk.isCorrect?1:0);

					
				}
				
				add_result("correct_result",corrects.join(";"));
				add_result("correctanswerset",corrects.join(";"));
				add_result("user_result",users.join(";"));
				add_result("buttonset", users.join(";"));
				add_result("duration",getTimestamp()-start_time);
				add_result("timeaverage",getTimestamp()-start_time);
				add_result("user_time", rc_time.join(";"));	
				add_result("timeset", rc_time.join(";"));
				add_result("stimidset",stimidAll.join(";"));
				add_result("type4set", type4All.join(";"));
				
				///////////////////////////////////////////////////////////////////
				///////////////////////////////////////////////////////////////////
				var type4set=type4All.join(";");
				var timeset=rc_time.join(";");
				var buttonset=users.join(";");
				var correctanswerset=corrects.join(";");
				var numset=""; 
				var radioset="";
				var commentset="";
				var radiolist1set="";
				var radiolist2set="";
				var radiolist3set="";
				var radiolist4set="";
				var radiolist5set="";
				var radiolist6set="";
				var radiolist7set="";
				var radiolist8set="";
				var radiolist9set="";
				var radiolist10set="";
				
				if (corrects.length>1)
				{
					commentset="{1}";
					for (var i=0;i<corrects.length-1;i++)
					{	
						var ordercomment=i+2;
						numset=numset+";"+"";
						radioset=radioset+";"+"";
						commentset=commentset+";"+"{"+ordercomment+"}";
						radiolist1set=radiolist1set+";"+"";
						radiolist2set=radiolist2set+";"+"";
						radiolist3set=radiolist3set+";"+"";
						radiolist4set=radiolist4set+";"+"";
						radiolist5set=radiolist5set+";"+"";
						radiolist6set=radiolist6set+";"+"";
						radiolist7set=radiolist7set+";"+"";
						radiolist8set=radiolist8set+";"+"";
						radiolist9set=radiolist9set+";"+"";
						radiolist10set=radiolist10set+";"+"";
					}
				}	
				var countOfCorrectNumber_ByType=getCorrectCountSortByType(numset,correctanswerset,type4set);
				var countOfCorrectButton_ByType=getCorrectCountSortByType(buttonset,correctanswerset,type4set);
				var countOfCorrectRadio_ByType=getCorrectCountSortByType(radioset,correctanswerset,type4set);
				var countOfCorrectButton_ByType_Corrected=getCorrectCountSortByType_Corrected(buttonset,correctanswerset,type4set);
				var percentageCorrectNumber_ByType=getPercentageCorreceSortByType(numset,correctanswerset,type4set);
				var percentageCorrectButton_ByType=getPercentageCorreceSortByType(buttonset,correctanswerset,type4set);
				var percentageCorrectRadio_ByType=getPercentageCorreceSortByType(radioset,correctanswerset,type4set);
				var meanNumber_ByType=getMeanSortByType(numset,type4set);
				var sumNumber_ByType=getSumSortByType(numset,type4set);
				var meanRT_ByType=getMeanSortByType(timeset,type4set);
				var meanDeviationNumber_ByType=getMeanDeviationSortByType(numset,correctanswerset,type4set);
				var sumWeightedRadio_ByType=getWeightedScoreSortByType(radioset,type4set,radiolist1set,radiolist2set,radiolist3set,radiolist4set,radiolist5set,radiolist6set,radiolist7set,radiolist8set,radiolist9set,radiolist10set);
				var type4_Unique=getType(type4set);
				add_result("countOfCorrectNumber_ByType", countOfCorrectNumber_ByType);
				add_result("countOfCorrectButton_ByType", countOfCorrectButton_ByType);
				add_result("countOfCorrectRadio_ByType", countOfCorrectRadio_ByType);
				add_result("countOfCorrectButton_ByType_Corrected", countOfCorrectButton_ByType_Corrected);
				add_result("percentageCorrectNumber_ByType", percentageCorrectNumber_ByType);
				add_result("percentageCorrectButton_ByType", percentageCorrectButton_ByType);
				add_result("percentageCorrectRadio_ByType", percentageCorrectRadio_ByType);
				add_result("meanNumber_ByType", meanNumber_ByType);
				add_result("sumNumber_ByType", sumNumber_ByType);
				add_result("meanRT_ByType", meanRT_ByType);
				add_result("meanDeviationNumber_ByType", meanDeviationNumber_ByType);
				add_result("sumWeightedRadio_ByType", sumWeightedRadio_ByType);
				add_result("type4_Unique", type4_Unique);
				////////////////////////////////////////////////////////////////////////////////////////////////
				////////////////////////////////////////////////////////////////////////////////////////////////
				//add_result("radioset", radioset);
				//add_result("numset", numset);
				//add_result("commentset", commentset);	
				document.getElementById("result").submit();	
			}

			function add_result(id, value)
			{
			   var elem = document.createElement("input");
			   elem.setAttribute("type", "text");
			   elem.setAttribute("id", id);
			   elem.setAttribute("name", id);
			   elem.setAttribute("value", value);
			   
			   document.getElementById("result").appendChild(elem);
			}
			
		</script>
</head>

<body style="padding: 0px; font-size: 14px; font-family:"微软雅黑", Arial, sans-serif, "新宋体";">

<%
Users u=(Users)request.getSession().getAttribute("cu");
int uid=u.getUserid();
int taskid=Integer.parseInt(request.getParameter("taskid"));
String lan=request.getParameter("lan");
String targetpagename=request.getParameter("targetpagename");

int projectid=0;
if (!(request.getParameter("projectid")==null)) {
projectid=Integer.parseInt(request.getParameter("projectid"));
}

int codematerial=0;
if (!(request.getParameter("codematerial")==null))  {
codematerial=Integer.parseInt(request.getParameter("codematerial"));
}

int sumitcoids=u.getCoid();


Vector<OPES_Task> ots=OPES_TaskDAO.getOPES_aTask(Integer.parseInt(request.getParameter("taskid")),lan);
if (ots.size()==0)
	{
response.sendRedirect("/lattice/"+targetpagename);
return; 
}
ots.get(0).setProjectid(Integer.parseInt(request.getParameter("projectid")));
request.getSession().setAttribute("ot",ots.get(0));

%> 
<form id="result" name="result" method="post" action="/lattice/OPESHandler?type=formal">
	<input type=hidden value="<%=request.getParameter("targetpagename") %>" name="targetpagename" id="targetpagename"/>
	
	<input type=hidden value="<%=sumitcoids %>" name="codematerial" id="codematerial"/>
	<input type=hidden value="<%=sumitcoids %>" name="coids" id="coids"/>
	<input type=hidden value="<%=sumitcoids %>" name="sumitcoids" id="sumitcoids"/>
	<input type=hidden value="<%=request.getParameter("taskid") %>" name="taskid" id="taskid"/>
 	
</form>

	<div
		style="height: 50px; width: 100%; text-align: center; margin-top: 0px; margin-left: 0px;">
		<div align="center" style="font-size: 60px; font-weight: bold">
			<span id="tips" style="color: red;"></span>
		</div>
	</div>

	
<div id='tb_div'>
	<table id="tb" align="center" border="1" style="margin-top: 0px;width:300px;height:300px;" cellspacing="0" cellpadding="0" onclick="check(event)">
		<!-- <tr style='width:100px;height:100px;'><td style='width:100px;height:100px;border:1px solid;'></td><td style='width:100px;height:100px;border:1px solid;'></td><td style='width:100px;height:100px;border:1px solid;'></td></tr>
			<tr style='width:100px;height:100px;'><td style='width:100px;height:100px;border:1px solid;background-color:#000;'></td><td style='width:100px;height:100px;border:1px solid;'></td><td style='width:100px;height:100px;border:1px solid;'></td></tr>
			<tr style='width:100px;height:100px;'><td style='width:100px;height:100px;border:1px solid;'></td><td style='width:100px;height:100px;border:1px solid;'></td><td style='width:100px;height:100px;border:1px solid;'></td></tr> -->
	</table>
</div>

</body>
</html>


